
&НаКлиенте
Процедура ВыполнитьКоманду(ИдентификаторКоманды, ОбъектыНазначенияМассив) Экспорт

   // Ссылку на исходный документ сохраняю в реквизите обработки
   Объект.СсылкаНаОбъект = ОбъектыНазначенияМассив[0];

   Если ЗначениеЗаполнено(Объект.СсылкаНаОбъект) Тогда
      // Мне нужно поучить от пользователя некоторую информацию информацию
      // для этого я открываю Форму внешней обработки заполнения объектов
      ЭтаФорма.Открыть();
   КонецЕсли;

КонецПроцедуры


&НаКлиенте
Процедура ВыполнитьАлгоритм(Команда)
   // Повторно открываю форму нужного объекта,
   // в моём случае это Документ \"Поступление товаров и услуг\"
   // Если форма уже открыта, то повторного открытия не происходит,
   // но возвращается объект \"Управляемая форма\"
   Параметр = Новый Структура("Ключ", СсылкаНаОбъект);
   Форма = ОткрытьФорму("Документ.ОтчетОРозничныхПродажах.ФормаОбъекта",Параметр);   //Укажите документ для которого получаем форму  !!!!!!!!!!!!
   ОбъектФормы = Форма.Объект;


   // Далее ваша функциональность
   // ОбъектФормы.Комментарий = формат(ТекущаяДата());
   ТаблицаЗначений = ПолучитьСписокТоваров(СсылкаНаОбъект, ВидЦены);
   Если ЗначениеЗаполнено(ТаблицаЗначений) Тогда
	   Для каждого Строка Из ТаблицаЗначений Цикл
		  НоваяСтрока = ОбъектФормы.Товары.Добавить();
		  НоваяСтрока.Номенклатура = Строка.Номенклатура;
		  НоваяСтрока.КоличествоУпаковок = 1;
		  НоваяСтрока.Цена = Строка.Цена;
		  НоваяСтрока.Сумма = Строка.Цена;
	   КонецЦикла;
   КонецЕсли;

   // Закрываю форму внешней обработки
   ЭтаФорма.Закрыть();

КонецПроцедуры


&НаСервереБезКонтекста
Функция ПолучитьСписокТоваров(Ссылка, ВидЦены)

	Запрос = Новый Запрос;
	Запрос.Текст =
		"ВЫБРАТЬ
		|	ПоступлениеТоваровУслугТовары.Номенклатура,
		|	ПоступлениеТоваровУслугТовары.Ссылка.Организация,
		|	ПоступлениеТоваровУслугТовары.Ссылка.Склад
		|ПОМЕСТИТЬ ВыборкаТоваров
		|ИЗ
		|	Документ.ПоступлениеТоваровУслуг.Товары КАК ПоступлениеТоваровУслугТовары
		|ГДЕ
		|	ПоступлениеТоваровУслугТовары.Ссылка = &Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТоварыОрганизацийОстатки.Номенклатура
		|ПОМЕСТИТЬ ТоварыНоменклатура
		|ИЗ
		|	ВыборкаТоваров КАК ВыборкаТоваров
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.ТоварыОрганизаций.Остатки(, ) КАК ТоварыОрганизацийОстатки
		|		ПО ВыборкаТоваров.Номенклатура = ТоварыОрганизацийОстатки.Номенклатура
		|			И ВыборкаТоваров.Склад = ТоварыОрганизацийОстатки.Склад
		|			И ВыборкаТоваров.Организация = ТоварыОрганизацийОстатки.Организация
		|ГДЕ
		|	ТоварыОрганизацийОстатки.КоличествоОстаток > 0
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|ВЫБРАТЬ
		|	ТоварыНоменклатура.Номенклатура,
		|	ЦеныНоменклатурыСрезПоследних.Цена
		|ИЗ
		|	ТоварыНоменклатура КАК ТоварыНоменклатура
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних КАК ЦеныНоменклатурыСрезПоследних
		|		ПО ТоварыНоменклатура.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
		|ГДЕ
		|	ЦеныНоменклатурыСрезПоследних.ВидЦены = &ВидЦены";

	Запрос.УстановитьПараметр("Ссылка", Ссылка);
	Запрос.УстановитьПараметр("ВидЦены", ВидЦены);

	РезультатЗапроса = Запрос.Выполнить().Выгрузить();

	Возврат РезультатЗапроса;

КонецФункции

&НаСервере
Функция ПриОткрытииНаСервере()
	Возврат Справочники.ВидыЦен.НайтиПоНаименованию("Розничная"); //Только для базы Домашнего задания
КонецФункции

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ВидЦены = ПриОткрытииНаСервере();
КонецПроцедуры
